library(readxl)
library(tidyverse)
library(car)
library(agricolae)
library(e1071)

```{r}
#     1. SETUP DATA
# Pastikan path ini benar di laptopmu
lokasi_file <- "D:/Semester 3/ADS Analisis Data Statisitika/Tugas besar ADS/dataset final banget.xlsx"

# Membaca Sheet "Nilai ADS"
# Kita fokus ke sheet ini karena sepertinya kolom 'kategorik' dan 'nilai' sudah ada di sini
data_nilai <- read_excel(lokasi_file, sheet = "Nilai ADS")

# Cek nama kolom untuk memastikan posisi
print("Nama Kolom Awal:")
print(colnames(data_nilai))

#     2. MEMBERSIHKAN DATA
# Mengubah nama kolom agar mudah dipanggil
# Asumsi urutan kolom: [1]RA, [2]RB, [3]RC, [4]UangSaku_Asli, [5]Kategorik
colnames(data_nilai)[1:3] <- c("Nilai_RA", "Nilai_RB", "Nilai_RC")
colnames(data_nilai)[5] <- "Kategori_Uang_Saku" 

# Menghitung Rata-rata Nilai ADS per mahasiswa
data_nilai <- data_nilai %>%
  mutate(Nilai_ADS = rowMeans(select(., Nilai_RA, Nilai_RB, Nilai_RC), na.rm = TRUE))

# Membuat Data Frame Khusus ANOVA
# Kita ambil kolom Kategori yang sudah kamu buat dan Nilai ADS
data_anova <- data_nilai %>%
  select(Kategori_Uang_Saku, Nilai_ADS) %>%
  drop_na() %>% # Buang baris yang kosong jika ada
  mutate(Kategori_Uang_Saku = as.factor(Kategori_Uang_Saku)) # Ubah jadi faktor

print("Struktur Data Final:")
str(data_anova)
print(head(data_anova))

#    3. VISUALISASI AWAL

# Boxplot
ggplot(data_anova, aes(x = Kategori_Uang_Saku, y = Nilai_ADS, fill = Kategori_Uang_Saku)) +
  geom_boxplot() +
  labs(
    title = "Pengaruh Kategori Uang Saku terhadap Nilai ADS",
    subtitle = "Tugas Besar ADS 2025",
    x = "Kategori Uang Saku",
    y = "Nilai Rata-rata ADS"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

#    4. UJI ASUMSI & ANOVA 

# Buat model ANOVA
model <- aov(Nilai_ADS ~ Kategori_Uang_Saku, data = data_anova)

# A. Uji Normalitas (Shapiro-Wilk)
print("--- UJI NORMALITAS (Shapiro-Wilk) ---")
shapiro_res <- shapiro.test(residuals(model))
print(shapiro_res)

# B. Uji Homogenitas (Levene's Test)
print("--- UJI HOMOGENITAS (Levene's Test) ---")
print(leveneTest(Nilai_ADS ~ Kategori_Uang_Saku, data = data_anova))

#     5. KEPUTUSAN UJI 

# Logika otomatis untuk memilih uji
if(shapiro_res$p.value > 0.05) {
  print("--- DATA NORMAL: MENGGUNAKAN ANOVA (Parametrik) ---")
  print(summary(model))
  
  # Uji Lanjut (Post-hoc) jika ANOVA signifikan (Pr(<F) < 0.05)
  # Gunakan Tukey HSD sebagai contoh
  # print(TukeyHSD(model))
  
} else {
  print("--- DATA TIDAK NORMAL: MENGGUNAKAN KRUSKAL-WALLIS (Non-Parametrik) ---")
  print(kruskal.test(Nilai_ADS ~ Kategori_Uang_Saku, data = data_anova))
}

#     6. VISUALISASI TAMBAHAN

# Dot plot
ggplot(data_anova, aes(x = Kategori_Uang_Saku, y = Nilai_ADS, fill = Kategori_Uang_Saku)) +
  geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.6) +
  labs(title = "Dot Plot Sebaran Nilai ADS", x = "Kategori", y = "Nilai ADS") +
  theme_minimal() +
  theme(legend.position = "none")

# Histogram Facet
ggplot(data_anova, aes(x = Nilai_ADS, fill = Kategori_Uang_Saku)) +
  geom_histogram(bins = 15, color = "white", alpha = 0.7) +
  facet_wrap(~Kategori_Uang_Saku) +
  labs(title = "Histogram Distribusi per Kategori", x = "Nilai ADS", y = "Frekuensi") +
  theme_minimal() +
  theme(legend.position = "none")

# Skewness
print(" NILAI SKEWNESS ")
skewness_stats <- data_anova %>%
  group_by(Kategori_Uang_Saku) %>%
  summarise(
    Skewness = skewness(Nilai_ADS, type = 2),
    Mean = mean(Nilai_ADS, na.rm = TRUE),
    SD = sd(Nilai_ADS, na.rm = TRUE)
  )
print(skewness_stats)
```